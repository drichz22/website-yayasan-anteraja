---
import { Image } from "astro:assets";
import navLogo from "../../shared/assets/Logo.jpeg";

//Active, Not active state logic
const currPath = Astro.url.pathname;

const isActive = (href: string) => {
  if (href === "/") return currPath === "/"; //Init Home active on first load
  return currPath === href || currPath.startsWith(href + "/");
};
---

<nav class="fixed top-0 left-0 w-full bg-white shadow-sm z-20 border-b border-gray-200">
    <div class="relative flex items-center w-full py-2 px-12">
        <!-- Logo -->
        <a href="/" aria-label="Go to Home Page" class="inline-flex items-center gap-2">
            <Image src={navLogo} alt="Navbar Logo" class="w-[48px] h-[48px] cursor-pointer" />
            <h1 class=" hidden sm:block text-lg text-brand-secondary font-bold">AMANAH SATRIA INDONESIA</h1>
        </a>

        <!-- Hamburger Icon (Mobile) -->
        <div class="ml-auto lg:hidden block text-black cursor-pointer">
            <div class="inline-flex items-center gap-8">
                <a class="bg-brand-primary hover:bg-brand-primary-hover text-white text-sm font-semibold py-2 px-4 rounded duration-300 transition-colors ease-in-out cursor-pointer" href="/#donation">
                    Donasi
                </a>
                <button class="cursor-pointer" id="menu-toggle" aria-label="Toggle Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path id="hamburgerPath" stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-md z-40 transform -translate-x-full transition-transform duration-300 ease-in-out lg:hidden">
            <div class="flex flex-col h-full">
                <div class="py-8 px-4">
                    <!-- Navigation Links -->
                    <nav class="flex-1">
                        <ul class="flex flex-col gap-4 px-6 ">
                            <li class="cursor-pointer"><a href="/" class={`px-2 py-1 rounded transition ${isActive("/") ? "bg-brand-primary text-white" : "text-black hover:bg-brand-primary hover:text-white"}`}>Beranda</a></li>
                            <li class="cursor-pointer"><a href="/about" class={`px-2 py-1 rounded transition ${isActive("/about") ? "bg-brand-primary text-white" : "text-black hover:bg-brand-primary hover:text-white"}`}>Tentang Kami</a></li>
                            <li class="cursor-pointer"><a href="/blog" class={`px-2 py-1 rounded transition ${isActive("/blog") ? "bg-brand-primary text-white" : "text-black hover:bg-brand-primary hover:text-white"}`}>Blog</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </aside>

        <!-- Menu (Desktop) -->
        <ul class="hidden lg:flex gap-6 font-semibold text-sm items-center ml-auto">
            <li>
                <a href="/" class={`nav-link px-2 py-2 transition-colors 
                    ${isActive("/") ? "text-gray-900" : "text-gray-600 hover:text-gray-900"}`}
                    aria-current={isActive("/") ? "page" : undefined}>
                    Beranda
                </a>
            </li>
            <li>
                <a href="/about" class={`nav-link px-2 py-2 transition-colors 
                    ${isActive("/about") ? "text-gray-900" : "text-gray-600 hover:text-gray-900"}`}
                    aria-current={isActive("/") ? "page" : undefined}>
                    Tentang Kami
                </a>
            </li>
            <li>
                <a href="/blog" class={`nav-link px-2 py-2 transition-colors 
                    ${isActive("/blog") ? "text-gray-900" : "text-gray-600 hover:text-gray-900"}`}
                    aria-current={isActive("/") ? "page" : undefined}>
                    Blog
                </a>
            </li>
            <a class="bg-brand-primary hover:bg-brand-primary-hover text-white font-semibold py-2 px-4 rounded duration-300 transition-colors ease-in-out" href="/#donation">
                Donasi
            </a>
        </ul>

        <!-- Indicator (Desktop) -->
        <div id="nav-indicator" class="absolute bottom-0 h-[2px] bg-brand-primary transition-all duration-300"></div>
    </div>
</nav>

<script>
    /**
     * Navbar hover and page active logic
     */
    function initNavIndicator() {
        const indicator = document.getElementById("nav-indicator") as HTMLDivElement | null;
        const links = document.querySelectorAll<HTMLAnchorElement>(".nav-link");
        const nav = document.querySelector("nav") as HTMLElement | null;

        if (!indicator || !nav || links.length === 0) return;

        let current: HTMLAnchorElement | null = document.querySelector<HTMLAnchorElement>('.nav-link[aria-current="page"]') ?? links[0] ?? null;

        const moveIndicator = (el: HTMLAnchorElement | null) => {
            if (!el) return;

            const rect = el.getBoundingClientRect();
            const parentRect = nav.getBoundingClientRect();

            indicator.style.width = `${rect.width}px`;
            indicator.style.left = `${rect.left - parentRect.left}px`;
        };

        links.forEach((link) => {
            link.addEventListener("mouseenter", () => {
            current = link;
            moveIndicator(current);
            });
        });

        nav.addEventListener("mouseleave", () => {
            const active = document.querySelector<HTMLAnchorElement>('.nav-link[aria-current="page"]');
            current = active ?? current;
            moveIndicator(current);
        });

        let raf = 0;
        const onResize = () => {
            cancelAnimationFrame(raf);
            raf = requestAnimationFrame(() => moveIndicator(current));
        };
        window.addEventListener("resize", onResize);

        const ro = new ResizeObserver(onResize);
        ro.observe(nav);

        (document as any).fonts?.ready?.then(() => moveIndicator(current));

        moveIndicator(current);
    }

    /**
     * Hamburger and mobile menu logic
     */
    function initMobileMenuToggle() {
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');

        if (menuToggle && sidebar) {
            menuToggle.addEventListener('click', () => {
                let attrString = "";
                if (document.getElementById("hamburgerPath")?.getAttribute("d") === "M4 6h16M4 12h16M4 18h16") attrString = "M6 18L18 6M6 6l12 12";
                else attrString = "M4 6h16M4 12h16M4 18h16"
                document.getElementById("hamburgerPath")?.setAttribute("d", attrString);
                
                sidebar.classList.toggle('-translate-x-full');
                sidebar.classList.toggle('translate-x-0');
            });
        }
    }

    document.addEventListener("astro:page-load", initNavIndicator);
    document.addEventListener("astro:page-load", initMobileMenuToggle);
</script>
